<launch>
<arg name="filename" default="$(find ros_unet)/rosbag.bag"/>
<arg name="weight_file" value="$(find ros_unet)/segment_dataset/dunet.pth"/>

<arg name="depth" value="helios2/depth/image_raw" />
<arg name="rgb"   value="aligned/rgb_to_depth/image_raw" />
<arg name="info"   value="helios2/camera_info" />
<!--arg name="depth" value="/cam0/k4a/depth/image_raw" />
<arg name="rgb"   value="/cam0/k4a/rgb_to_depth/image_raw" /-->

<arg name="verbose" default="false"/>
<arg name="generate_points" default="true"/>
<arg name="cameras" default="[0,]" />
<arg name="sensor_model" default="helios"/>
<arg name="voxel_leaf" value="0.05" />

<!--
  match_mode
  0 = NO_MATCH     : Return unsynced, duplicated instances on topic $(arg output_topic)
  1 = CURRENT_ONLY : Remove duplicated instance between two cameras.
  2 = TRACKING     : Make instance id be consistent over frames.
-->
<arg name="match_mode" value="2"/>

<!--
  match_method
  0 = WITHOUT_IOU : Compare only distance of center for matcihng instance
  1 = WITH_IOU    : Compare IoU also for matching instance. More accurate but more slow.
-->
<arg name="match_method" default="0"/>

<node name="rosbag" pkg="rosbag" type="play"
    args="-r 0.05 --loop $(arg filename)" required="true" unless="$(eval filename=='')"/>

<node name="unet_node" pkg="ros_unet" type="ros_unet.py" output="screen" required="true">
    <remap from="~cam0/rgb"          to="/cam0/$(arg rgb)" />
    <remap from="~cam0/depth"        to="/cam0/$(arg depth)" />
    <remap from="~cam0/info"         to="/cam0/$(arg info)" />
    <remap from="~cam1/rgb"          to="/cam1/$(arg rgb)" />
    <remap from="~cam1/depth"        to="/cam1/$(arg depth)" />
    <remap from="~cam1/info"         to="/cam1/$(arg info)" />

    <rosparam subst_value="True">
      input_ch: 6
      cameras: $(arg cameras)
      weight_file: "$(arg weight_file)"
    </rosparam>
</node>

<node name="pipeline" pkg="ros_unet" type="pipeline" output="screen" required="true">
    <remap from="~cam0/rgb"          to="/cam0/$(arg rgb)" />
    <remap from="~cam0/depth"        to="/cam0/$(arg depth)" />
    <remap from="~cam0/camera_info"  to="/cam0/$(arg info)" />
    <remap from="~cam0/mask"         to="/unet_node/cam0/mask" />

    <remap from="~cam1/rgb"          to="/cam1/$(arg rgb)" />
    <remap from="~cam1/depth"        to="/cam1/$(arg depth)" />
    <remap from="~cam1/camera_info"  to="/cam1/$(arg info)" />
    <remap from="~cam1/mask"         to="/unet_node/cam1/mask" />

    <rosparam subst_value="True">
      compute_image_size: [640, 480]
      cameras: $(arg cameras)
      verbose: $(arg verbose)
      match_mode: $(arg match_mode)
      match_method: $(arg match_method)
      min_z_floor: -0.83
      min_points_of_cluster: 5
      sensor_model: $(arg sensor_model)
      voxel_leaf: $(arg voxel_leaf)
      generate_points: $(arg generate_points)
    </rosparam>
</node>

<node name="rviz" pkg="rviz" type="rviz" args="-d $(find ros_unet)/rviz/unet.rviz" required="true"/>

<arg name="load_config" default="true"/>
<arg name="side" default="up"/>
<group if="$(arg load_config)">
  <node pkg="rostopic" type="rostopic" name="tilt"
  args="pub /unloader/cam_tilt unloader_msgs/MultiarmPose 
  '{header: {seq: 0, stamp: {secs: 0, nsecs: 0}, frame_id: ''},
    cam0_tilt: true,
    cam1_tilt: true}' -r 10" required="true" if="$(eval side=='up')"/>
  <node pkg="rostopic" type="rostopic" name="tilt"
  args="pub /unloader/cam_tilt unloader_msgs/MultiarmPose 
  '{header: {seq: 0, stamp: {secs: 0, nsecs: 0}, frame_id: ''},
    cam0_tilt: false,
    cam1_tilt: false}' -r 10" required="true" if="$(eval side=='down')"/>
  <node pkg="tf2_ros" type="static_transform_publisher" name="link0"
  args="0 0 0 0 0 0 1 cam0_rgb_link cam0_rgb_camera_link"/>
  <node pkg="tf2_ros" type="static_transform_publisher" name="link1"
  args="0 0 0 0 0 0 1 cam1_rgb_link cam1_rgb_camera_link"/>
</group>
<include file="$(find unloader_calib)/launch/cam_tf_publisher.launch" if="$(arg load_config)"/>

<rosparam command="load" file="$(find ros_unet)/config/calib_info_for_tf.yaml" if="$(arg load_config)"/>

</launch>
